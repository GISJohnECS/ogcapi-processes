== Requirement Class "Core"

////
for now, normative statements are often included inline. This will be re-factored later.
////

=== Overview

include::requirements/requirements_class_core.adoc[]

TODO: Overview?

In addition, each server publishes a formal definition of the API (`APIDefinition`),
which describes the capabilities of the server and which can be used by
clients to connect to the server or
by development tools to support the implementation of servers and clients.

[#img_core,reftext='{figure-caption} {counter:figure-num}']
.Resources in the Core requirements class
image::figures/PT1_FIG01.png[align="center"]

CAUTION: link:https://github.com/opengeospatial/WFS_FES/issues/30[ISSUE 30] +
Allow also features that do not belong to any collection?

=== Retrieve API landing page

==== Operation

include::requirements/op/REQ_root-op.adoc[]

==== Response

include::requirements/op/REQ_root-success.adoc[]

.link:https://raw.githubusercontent.com/opengeospatial/WFS_FES/master/core/openapi/schemas/root.yaml[Schema for the landing page]
[source,YAML]
----
type: object
required:
  - links
properties:
  links:
    type: array
    items:
      $ref: https://raw.githubusercontent.com/opengeospatial/WFS_FES/master/core/openapi/schemas/link.yaml
----

.Landing page response document
=================
[source,JSON]
----
{
  "links": [
    { "href": "http://data.example.org/",
      "rel": "self", "type": "application/json", "title": "this document" },
    { "href": "http://data.example.org/api",
      "rel": "service", "type": "application/openapi+json;version=3.0", "title": "the API definition" },
    { "href": "http://data.example.org/conformance",
      "rel": "conformance", "type": "application/json", "title": "WFS 3.0 conformance classes implemented by this server" },
    { "href": "http://data.example.org/collections",
      "rel": "data", "type": "application/json", "title": "Metadata about the feature collections" }
  ]
}
----
=================

==== Error situations

=== Retrieve API definition

==== Operation

Every WFS provides an API definition that describes the capabilities
of the server and which can be used by developers to understand the API,
by software clients to connect to the server, or
by development tools to support the implementation of servers and clients.

include::requirements/core/REQ_api-definition-op.adoc[]

==== Response

include::requirements/core/REQ_api-definition-success.adoc[]

include::requirements/core/REC_api-definition-oas.adoc[]

If multiple API definition formats are supported by a server, use
content negotiation to select the desired representation.

The API definition document describes the API. In other words,
there is no need to include the `/api` operation in the API definition itself.

The idea is that any WFS can be used by developers that are familiar with
the API definition language(s) supported by the server. For example, if
an OpenAPI definition is used, it should be possible to create a working
client using the OpenAPI definition. The developer may need to learn a little
bit about geometry data types, etc., but it should not be required to read
this standard to access the data via the API.

==== Error situations

See <<http_status_codes>> for general guidance.

See <<http_status_codes>> for general guidance.

Reqirement

Operation

Response

URL-Example

Schema

Example

Errors

=== HTTP 1.1

[width="90%",cols="2,6a"]
|===
|*Requirement {counter:req-id}* |/req/core/http +

The server SHALL conform to <<rfc2616,HTTP 1.1>>.
|===

This includes the correct use of status codes, headers, etc.

=== Web caching

Entity tags are a mechanism for web cache validation and for supporting conditional
requests to reduce network traffic. Entity tags are specified by <<rfc2616,HTTP/1.1 (RFC 2616)>>.

[[rec_etag]]
[width="90%",cols="2,6a"]
|===
|Recommendation {counter:rec-id} |/rec/core/etag +

The service SHOULD support entity tags and the associated headers as
specified by HTTP/1.1.
|===

NOTE: TODO +
Add an example OpenAPI operation (headers, response codes). Here or in clause 9.

=== Support for cross-origin requests

To access data from a HTML page where the data is on another host than
the webpage is by default prohibited for security reasons ("same-origin policy").
A typical example is a web-application accessing feature data from
multiple distributed datasets.

[width="90%",cols="2,6a"]
|===
|Recommendation {counter:rec-id} |/rec/core/cross-origin +

If the server is intended to be accessed from the browser, cross-origin
requests SHOULD be supported. Note that support can also be added in a
proxy layer on top of the server.
|===

Two common mechanisms to support cross-origin requests are:

* link:https://en.wikipedia.org/wiki/Cross-origin_resource_sharing[Cross-origin resource sharing (CORS)]
* link:https://en.wikipedia.org/wiki/JSONP[JSONP (JSON with padding)]

[[rec_html]]
[width="90%",cols="2,6a"]
|===
|Recommendation {counter:rec-id} |/rec/core/html +

To support browsing a WFS with a web browser and to enable search engines to crawl
and index a dataset, implementations SHOULD consider to support an HTML encoding.
|===

[[rec_geojson]]
[width="90%",cols="2,6a"]
|===
|Recommendation {counter:rec-id} |/rec/core/geojson +

If the feature data can be represented for the intended use in GeoJSON,
implementations SHOULD consider to support GeoJSON as an
encoding for features and feature collections.
|===

<<overview,Clause 6 (Overview)>> includes a discussion about the recommended
encodings.

A template for the definition of the parameter `f` in YAML according to OpenAPI 3.0 is available at
link:https://raw.githubusercontent.com/opengeospatial/WFS_FES/master/core/openapi/parameters/f.yaml[f.yaml].

=== Retrieve a process collection

TBD

==== Operation

include::requirements/op/REQ_process-collection-op.adoc[]

==== Response

include::requirements/op/REQ_process-collection-success.adoc[]

.link:https://raw.githubusercontent.com/opengeospatial/wps-rest-binding/master/core/openapi/schemas/processCollection.yaml[Schema for the process collection]
[source,YAML]
----
type: object
required:
  - processes
properties:
  processes:
    type: array
    items:
      $ref: '#/components/schemas/processSummary'
----


==== Error situations

.Example of HTTP GET request for retrieving the list of offered processes encoded as JSON.
[source]
----
http://hostname.org/wps-rest/processes
----

.Example of Process list encoded as JSON.
[source,json]
----
{
  "ProcessSummaries": [
    {
      "identifier": "ConvexHullAlgorithm",
      "title": "Convex Hull Algorithm",
      "processVersion": "1.0.0",
      "jobControlOptions": "sync-execute async-execute",
      "processDescription": "http://hostname.org/wps-rest/processes/ConvexHullAlgorithm"
    },...
    ]
}
----

=== Retrieve a process

TBD

==== Operation

include::requirements/op/REQ_process-op.adoc[]

==== Response

include::requirements/op/REQ_process-success.adoc[]

.link:https://raw.githubusercontent.com/opengeospatial/wps-rest-binding/master/core/openapi/schemas/processCollection.yaml[Schema for a process]
[source,YAML]
----
type: object
required:
  - process
properties:
   process:
      $ref: '#/components/schemas/process'
----


==== Error situations

.Example of HTTP GET request for retrieving a process encoded as JSON.
[source]
----
http://hostname.org/wps-rest/processes/buffer
----

.Example of a process encoded as JSON.
[source,json]
----



----

=== Retrieve a job collection

TBD

==== Operation

include::requirements/op/REQ_job-collection-op.adoc[]

==== Response

include::requirements/op/REQ_job-collection-success.adoc[]

.link:https://raw.githubusercontent.com/opengeospatial/wps-rest-binding/master/core/openapi/schemas/jobList.yaml[Schema for the job collection]
[source,YAML]
----
type: object
properties:
    jobs:
       type: array
       items:
          type: string
----


==== Error situations

.Example of HTTP GET request for retrieving the list of jobs of a process encoded as JSON.
[source]
----
http://hostname.org/wps-rest/processes/buffer/jobs
----

.Example of a job list encoded as JSON.
[source,json]
----



----

=== Create a new job

TBD

==== Operation

include::requirements/op/REQ_job-creation-op.adoc[]

==== Request

include::requirements/op/REQ_job-creation-request.adoc[]

.link:https://raw.githubusercontent.com/opengeospatial/wps-rest-binding/master/core/openapi/schemas/execute.yaml[Schema for execute]
[source,YAML]
----
type: object
required:
    - outputs
properties:
    inputs:
       type: array
       items:
            $ref: '#/components/schemas/input'
    outputs:
       type: array
       items:
            $ref: '#/components/schemas/output'
----

==== Response

include::requirements/op/REQ_job-creation-success.adoc[]

include::requirements/op/REQ_job-creation-success-header.adoc[]

==== Error situations

=== Retrieve a job

TBD

==== Operation

include::requirements/op/REQ_job-op.adoc[]

==== Response

include::requirements/op/REQ_job-success.adoc[]

.link:https://raw.githubusercontent.com/opengeospatial/wps-rest-binding/master/core/openapi/schemas/execute.yaml[Schema for execute]
[source,YAML]
----
type: object
required:
    - status
properties:
   status:
      type: string
      enum:
        - accepted
        - running
        - successful
        - failed
message:
   type: string
progress:
   type: integer
   minimum: 0
   maximum: 100
----

==== Error situations

.Example of HTTP GET request for retrieving a job of a process encoded as JSON.
[source]
----
http://hostname.org/wps-rest/processes/buffer/jobs/81574318-1eb1-4d7c-af61-4b3fbcf33c4f
----

.Example of a job encoded as JSON.
[source,json]
----
{
  "status": "accepted",
  "message": "Process started",
  "progress": 0
}
----

=== Retrieve a job result

TBD

==== Operation

include::requirements/op/REQ_job-result-op.adoc[]

==== Response

include::requirements/op/REQ_job-result-success.adoc[]

.link:https://raw.githubusercontent.com/opengeospatial/wps-rest-binding/master/core/openapi/schemas/result.yaml[Schema for result]
[source,YAML]
----
type: object
required:
    - outputs
properties:
   outputs:
       type: array
       items:
          $ref: '#/components/schemas/outputInfo'
----

==== Error situations

.Example of HTTP GET request for retrieving a job of a process encoded as JSON.
[source]
----
http://hostname.org/wps-rest/processes/buffer/jobs/81574318-1eb1-4d7c-af61-4b3fbcf33c4f
----

.Example of a job encoded as JSON.
[source,json]
----
{
  "outputs": [
    {
      "id": "output1",
      "value": "0.6"
    },
    {
      "id": "output2",
      "value": "http://hostname.org/wps-rest/result/7j4g5325ge"
    }
  ]
}
----